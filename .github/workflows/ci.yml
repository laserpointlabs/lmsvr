name: CI Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Set up Ollama
      uses: ai-action/setup-ollama@v1
      with:
        # Optional: specify version if needed
        # version: latest
    
    - name: Cache Ollama Models
      uses: actions/cache@v4
      with:
        path: ~/.ollama
        key: ${{ runner.os }}-ollama-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-ollama-
    
    - name: Verify Ollama is running
      run: |
        ollama --version
        ollama list || echo "No models yet"
        # Wait for Ollama service to be ready
        for i in {1..30}; do
          if curl -f http://localhost:11434/api/tags; then
            echo "Ollama is ready"
            break
          fi
          echo "Waiting for Ollama... ($i/30)"
          sleep 2
        done
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r api_gateway/requirements.txt
        pip install -r requirements-dev.txt
    
    - name: Initialize database
      run: |
        mkdir -p data
        python3 -c "from api_gateway.database import init_db; init_db()"
    
    - name: Start API Gateway
      env:
        DATABASE_URL: sqlite:///./data/lmsvr.db
        OLLAMA_BASE_URL: http://localhost:11434
        LOG_LEVEL: INFO
      run: |
        # Start API Gateway in background
        cd api_gateway
        nohup uvicorn main:app --host 0.0.0.0 --port 8001 > /tmp/api_gateway.log 2>&1 &
        echo $! > /tmp/api_gateway.pid
        sleep 5
        # Show logs for debugging
        tail -20 /tmp/api_gateway.log || true
    
    - name: Check API Gateway health
      run: |
        for i in {1..30}; do
          if curl -f http://localhost:8001/health; then
            echo "API Gateway is healthy"
            break
          fi
          echo "Waiting for API Gateway... ($i/30)"
          sleep 2
        done
    
    - name: Run database tests
      run: |
        pytest tests/test_database.py -v
    
    - name: Run CLI tests
      run: |
        pytest tests/test_cli.py -v
    
    - name: Run API tests
      run: |
        pytest tests/test_api.py -v
      env:
        API_BASE_URL: http://localhost:8001
    
    - name: Run Ollama integration tests
      run: |
        pytest tests/test_ollama_integration.py -v -m integration
      env:
        API_BASE_URL: http://localhost:8001
    
    - name: Test with actual Ollama model (optional)
      if: success()
      run: |
        # Pull a small model for testing (if not cached)
        ollama pull llama3.2:1b || echo "Model pull failed or already exists"
        # Test that we can list models via API
        python3 -c "
        import httpx
        import os
        from api_gateway.database import get_db_session_sync, Customer, APIKey
        from api_gateway.auth import hash_api_key
        
        # Create test customer and key
        db = get_db_session_sync()
        customer = Customer(name='CI Test', email='ci@test.com', active=True)
        db.add(customer)
        db.commit()
        
        api_key = 'sk_test_ci_key'
        db_key = APIKey(customer_id=customer.id, key_hash=hash_api_key(api_key), active=True)
        db.add(db_key)
        db.commit()
        
        # Test API
        with httpx.Client() as client:
            resp = client.get('http://localhost:8001/api/models', 
                            headers={'Authorization': f'Bearer {api_key}'})
            assert resp.status_code == 200
            data = resp.json()
            print(f'âœ“ API Gateway can communicate with Ollama')
            print(f'  Found {len(data.get(\"models\", []))} models')
        "
    
    - name: Check code quality
      run: |
        python -m py_compile api_gateway/*.py cli/*.py || true
    
    - name: Cleanup
      if: always()
      run: |
        if [ -f /tmp/api_gateway.pid ]; then
          kill $(cat /tmp/api_gateway.pid) || true
        fi
        pkill -f uvicorn || true
        ollama stop || true
